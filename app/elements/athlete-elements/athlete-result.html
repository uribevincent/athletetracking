<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="athlete-result">
	<template>
		<style include="shared-styles">
			:host {
				display: block;
			}
			span, input {
				@apply(--paper-font-body2);
			}
		</style>

	<iron-pages selected="{{selectedPage}}">
		<paper-material elevation="1"	style="overflow-x:auto;">
			<table>
				<thead>
					<tr>
						<th>Date</th>
						<th>Distance</th>
						<th>Compétition</th>
						<th>Temps réel</th>
						<th>Temps officiel</th>
						<th>Position générale</th>
						<th>Position catégorie</th>
					</tr>
				</thead>
				<tbody>
					<template is="dom-repeat" items="[[results]]" as="result">
						<tr>
							<td>{{result.date}}</td>
							<td>{{result.distance}}</td>
							<td>{{result.name}}</td>
							<td>{{result.time.real}}</td>
							<td>{{result.time.official}}</td>
							<td>{{result.position.global}}</td>
							<td>{{result.position.category}}</td>
						</tr>
					</template>
				</tbody>
			</table>
			<paper-button raised on-tap="openDialog" hidden$="{{!editEnabled}}" >Nouveau résultat</paper-button>
		</paper-material>

	<!--<paper-dialog id="modal">-->

	<paper-material elevation="1"	style="overflow-x:auto;">

		<h2>Nouveau résultat de compétition</h2>

		<form is="iron-form">
			<paper-input label="Date" value="{{raceDate}}" requiered auto-validate type="date"></paper-input>
			<paper-dropdown-menu label="Distance">
				<paper-listbox class="dropdown-content" attr-for-selected="value" selected="{{raceDistance}}">
						<paper-item value="Marathon" >Marathon</paper-item>
						<paper-item value="21K" >Semi-marathon</paper-item>
						<paper-item value="10K" >10 km</paper-item>
						<paper-item value="5K" >5 km</paper-item>
						<paper-item value="1500" >1500 m</paper-item>
						<paper-item value="3000" >3000 m</paper-item>
						<paper-item value="5000" >5000 m</paper-item>
						<paper-item value="10000" >10000 m</paper-item>
				</paper-listbox>
			</paper-dropdown-menu>
			<paper-input label="Compétition" value="{{raceName}}" required ></paper-input>
			<paper-input label="Temps officiel" value="{{raceOfficialTime}}" required type="time" step="1"></paper-input>
			<paper-input label="Temps réel" value="{{raceRealTime}}" type="time" step="1" ></paper-input>
			<paper-input label="Position générale" value="{{raceGlobalPosition}}" type="number"></paper-input>
			<paper-input label="Position catégorie" value="{{raceCategoryPosition}}" type="number"></paper-input>
			<div class="buttons">
				<paper-button on-tap="addRace">Enregistrer</paper-button>
				<paper-button on-tap="cancelRace">Annuler</paper-button>
			</div>
		</form>
	</paper-material>
<!---	</paper-dialog>-->
</iron-pages>
</template>

	<script>
	(function() {
		'use strict';

		Polymer({
		is: 'athlete-result',

		properties: {
			editEnabled: {
				type: Boolean,
				value: false
			},
			selectedPage:{
				type: Number,
				value: 0,
			},
			selected: {
				type: Number,
				value: 0
			},
			editEnabled:{
				type: Boolean,
				notify: true,
				reflectToAttribute: true
			},
				athlete: {
				type: String,
				notify: true,
				reflectToAttribute: true,
				observer: "loadResults"
			},
			results: {
				type: Object,
				notify: true,
				value: null
			}
		},
 		setResults: function(results) {
 			var orderedResults = _.sortBy(results, function(r){ if(r !== undefined){return r.date;}});
			this.results = _.map(orderedResults.reverse(), function(r){ return r;});
		},
		loadResults: function(val){
			var me = this;
			var ref = new Firebase(app.firebaseURL + '/results/' + val);
			this.editEnabled = val === app.authData.uid;
			ref.orderByChild("date").on('value', function(snapshot) {
				var data = snapshot.val();
				me.setResults(data);
			});
		},
		addRace: function(){
			var me = this;
			var raceDate = new Date(me.raceDate);
			var ref = new Firebase(app.firebaseURL + '/results/' + app.authData.uid);
			ref.push({
				date: raceDate,
				distance: me.raceDistance,
				name: me.raceName,
				time: {
					real: me.raceRealTime,
					official: me.raceOfficialTime
				},
				position: {
					global: me.raceGlobalPosition,
					categoryPosition: me.raceCategoryPosition
				}
			});
			var mm = (raceDate.getMonth()+1).toString(); // getMonth() is zero-based

			var logRef = new Firebase(app.firebaseURL + '/training-log/' + app.authData.uid + '/' + raceDate.getFullYear() + '/' + (mm[1]?mm:"0"+mm[0]));
			logRef.push({
				type: 'race',
				dayNumber: raceDate.getDate() + 1,
				distance: me.raceDistance,
				name: me.raceName,
				time: {
					real: me.raceRealTime,
					official: me.raceOfficialTime
				},
				position: {
					global: me.raceGlobalPosition,
					categoryPosition: me.raceCategoryPosition
				}
			});
				this.selectedPage = 0;

		},
		cancelRace: function(){

				this.selectedPage = 0;
			},
		openDialog: function(){
				/*var dialog = document.getElementById("modal");
				if (dialog) {
				dialog.open();
				}*/
				this.selectedPage = 1;
		}


		});
	})();
	</script>
</dom-module>
