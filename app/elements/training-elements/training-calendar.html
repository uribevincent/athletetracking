<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="training-calendar">
<template>
	<style include="shared-styles" is="custom-style">
		:host {
			display: block;
		}

		span,
		input {
			@apply(--paper-font-body2);
		}
		@media (max-width: 600px) {

			.flex {
				@apply(--layout-horizontal);
				@apply(--layout-wrap);
			}
		}

		.flex {
				@apply(--layout-horizontal);
				@apply(--layout-wrap);
			}

		.monthPicker {
			@apply(--layout-horizontal);
			@apply(--layout-wrap);
		}

		.month{
			font-size: 0.8rem;
		}

		.flex paper-card{
			width: 14%;
			min-height: 100px;
			margin-right:4px;
			margin-bottom:4px;
			min-width: 100px;
		}

		.flex .empty{
			width: 14%;
			min-height: 100px;
			margin-right:4px;
			margin-bottom:4px;
		}

		.race{
			color: red;

		}

		.newEvent{
			color: blue;

		}
		.training{
			color: green;
		}

		.event{
				position: absolute;
				top: 0;
				left: 0;
			width: 100%
		}

			paper-card.day { @apply(--layout-horizontal); }


		.card-title {
			color: #BBB;
			text-align: center;
			vertical-align: middle;
			font-size: 5vw;
			/*width: 100px;
			height: 170px;*/
			/*position: relative;*/
		}
		.day-content {
			@apply(--layout-flex);
			float: left;
		}
		.card-header { @apply(--paper-font-headline); }
		.card-name { color: var(--paper-grey-600); margin: 10px 0; }

		paper-button {
			min-width: 0px;
		}
		 paper-dialog.form {
		 	width: 50%;
		 }
	</style>

	<iron-pages selected="{{selectedPage}}">
	<div>
		<div class="container flex">
			<template is="dom-repeat" items="[[days]]" as="day" >
				<template is="dom-if" if="{{!day}}">
					<div class="empty"></div>
				</template>
				<template is="dom-if" if="{{day}}">

					<paper-card class="day">
						<div class="card-title">
							{{day.dayNumber}}
						</div>
		 				<div class="day-content">
							<div class="card-content">
								<!--<div class="card-header">Rate this album</div>
								<div class="card-name">Mac Miller</div>
								<div>Live from space</div>-->
							</div>
							<div class="card-actions horizontal justified">
								<template is="dom-repeat" items="[[day.logs]]">
									<paper-button class$="{{item.type}}" data-log="{{item}}" on-tap="openDialog">
										<i class="fa fa-heartbeat" aria-hidden="true"></i>
										<paper-tooltip>Editer</paper-tooltip>
									</paper-button>
								</template>
									<paper-button class="newEvent" data-arg="{{day}}" on-tap="openDialog">
										<i class="fa fa-calendar-plus-o" aria-hidden="true"></i>
										<paper-tooltip>Nouvel évènement</paper-tooltip>
									</paper-button>
							</div>
						</div>
					</paper-card>
				</template>
			</template>


		</div>
	</div>
	<div>
		<h2>Nouvel évènement</h2>
			<form is="iron-form">
				<paper-dropdown-menu flex	label="Type">
					<paper-listbox class="dropdown-content" attr-for-selected="value"	selected="{{currentEvent.type}}">
						<paper-item value="running">Course à pied</paper-item>
						<paper-item value="cycling">Cyclisme</paper-item>
						<paper-item value="swimming">Natation</paper-item>
						<paper-item value="tennis">Tennis</paper-item>
						<paper-item value="race">Compétition</paper-item>
					</paper-listbox>
				</paper-dropdown-menu>

				<paper-textarea  label="Séance prévue" value="{{currentEvent.session_scheduled}}"></paper-textarea>
				<paper-textarea  label="Séance réalisée" value="{{currentEvent.session_real}}"></paper-textarea>
				<paper-input  label="Distance totale" value="{{currentEvent.distance}}" pattern="[0-9]*"></paper-input>
				<paper-input  label="Temps total" value="{{currentEvent.time}}" type="time" step="1" ></paper-input>
				Fréquence cardiaque moyenne <paper-slider pin value="{{currentEvent.distance.heartFrequency}}" max="220"></paper-slider>
				RPE <paper-slider pin snaps max="10" max-markers="10" step="1" value="{{currentEvent.rpe}}"></paper-slider>
				<paper-textarea  label="Commentaire" value="{{currentEvent.comment}}"></paper-textarea>

				<div class="buttons">
				   	<paper-button raised on-tap="saveEvent">Enregistrer</paper-button>
			   		<paper-button on-tap="cancelEvent">Annuler</paper-button>
				</div>
			</form>
	</div>
	</iron-pages>
</template>

<script>
	(function() {
		'use strict';

		Polymer({
			is: 'training-calendar',

			properties: {
				currentEvent: Object,
				selectedPage: {
					type: Number,
					value: 0,
				},
				trainings: {
					notify: true
				},
				date: {
					notify: true
				}
			},

			//observers: [ "computeCalendar(month)"],


			observers: [ "_renderCalendar(trainings)"],


			getDaysToMonday: function(d) {
				var dayOfWeek = new Date(d.getFullYear(), d.getMonth(), 1).getDay();
				if(dayOfWeek == 0){
					return 6;
				}
				else{
					return dayOfWeek - 1;
				}
			},
			openDialog: function(e){
				if(e.currentTarget.className.startsWith('newEvent')){
					this.currentEvent = {dayNumber: e.currentTarget.dataArg.dayNumber};
				}
				else{
					this.currentEvent = e.currentTarget.dataLog;
				}
				this.selectedPage = 1;
			},

			getDayIndex: function(dayNumber, diff){
				var index = _.findIndex(this.days, function(d){
					if(d === null){ return false; }
					return d.dayNumber == dayNumber;
				});
				return index - (diff == 0 ? 0 : diff - 1);
			},
			findLog: function(logId){
				var lIndex = -1;
				var dIndex = _.findIndex(this.days,
					function(d){
						if(d === null){ return false; }
						lIndex = _.findIndex(d.logs,
							function(l){
								return l.uid == logId;
							});
					return lIndex > -1;
				});
				return {day: dIndex, log: lIndex};
			},
			_renderCalendar: function(arr){
					this.days = new Array();
					var year = this.date.substring(0,4);
					var month = this.date.substring(5);
					var date = new Date(year, month, 0);
					var limit = parseInt(date.getDate());
					var diff = this.getDaysToMonday(date);
					//add empty days
					for(var j = 0; j < diff; j++){
						this.push('days',null);
					}
					//Generate month calendar
					for(var i = 0; i < limit; i++){
						var o = {
							fullDate: new Date(year, month, i + 1),
							dayNumber: i + 1,
							logs: []
						};
						this.push('days',o);
					}

					//Get logs
					var me = this;
					_.each(arr,function(training){
						var dIndex = me.getDayIndex(training.dayNumber, diff);
						if(dIndex > -1){
							training.uid = training.__firebaseKey__;
							me.push("days.#" + dIndex + ".logs", training);
						}
					});
			},
			/*computeCalendar: function(m){
				if(m !== "" ){
					this.days = new Array();
					var date = new Date(m.substring(0,4), m.substring(5), 0);
					this.selectedDate = {};
					this.selectedDate.year = m.substring(0,4);
					this.selectedDate.month = m.substring(5);
					var limit = parseInt(date.getDate());
					var diff = this.getDaysToMonday(date);
					//add empty days
					for(var j = 0; j < diff; j++){
						this.push('days',null);
					}
					//Generate month calendar
					for(var i = 0; i < limit; i++){
						var o = {
							fullDate: new Date(this.year, this.month, i + 1),
							dayNumber: i + 1,
							logs: []
						};
						this.push('days',o);
					}

					//Get logs
					var me = this;

					var ref = new Firebase(app.firebaseURL + '/training-log/' + app.authData.uid +'/' + this.selectedDate.year + '/' + this.selectedDate.month);
					ref.on('child_added', function(snapshot) {
						var newLog = snapshot.val();
						var dIndex = me.getDayIndex(newLog.dayNumber, diff);
						if(dIndex > -1){
							newLog.uid = snapshot.key();
							me.push("days.#" + dIndex + ".logs", newLog);
						}
					});

					ref.on('child_changed', function(snapshot, previous) {
						var updatedLog = snapshot.val();
						updatedLog.uid = snapshot.key();
						var log = me.findLog(updatedLog.uid);
						var oldLogIndex = log.day - (diff == 0 ? 0 : diff - 1);
						var oldLog = me.get('days.#' + oldLogIndex);
						var dIndex = me.getDayIndex(updatedLog.dayNumber, diff);
						me.splice("days.#" + oldLogIndex + ".logs", log.log, 1);
						me.push("days.#" + dIndex + ".logs", updatedLog);

						if(dIndex > -1){
							var d = me.get('days.#' + dIndex);
							var index = _.findIndex(d.logs, function(d){
								return d.uid == snapshot.key();
							});
							//day changed
							if(index > -1) {
								me.splice("days.#" + dIndex + ".logs", index, 1,updatedLog);
							}
						}
					});
					ref.on('child_removed', function(snapshot, previous) {
						var deletedLog = snapshot.val();
						var dIndex = me.getDayIndex(deletedLog.dayNumber, diff);
						if(dIndex > -1){
							var d = me.get('days.#' + dIndex);
							var index = _.findIndex(d.logs, function(d){
								return d.uid == snapshot.key();
							});
							if(index > -1) me.splice("days.#" + dIndex + ".logs", index, 1);
						}
					});
				}
			},*/
			saveEvent: function(e){
				var me = this;
				var year = this.date.substring(0,4);
				var month = this.date.substring(5);
				/*var ref = new Firebase(app.firebaseURL + '/training-log/' + app.authData.uid + '/' + year + '/' + month);
				if(me.currentEvent.uid !== undefined){
					ref.child(me.currentEvent.uid).set({
						type: me.currentEvent.type,
						comment: me.currentEvent.comment,
						dayNumber: me.currentEvent.dayNumber,
						distance: me.currentEvent.distance,
						heartFrequency: me.currentEvent.heartFrequency,
						rpe: me.currentEvent.rpe,
						session_real: me.currentEvent.session_real,
						session_scheduled: me.currentEvent.session_scheduled,
						time: me.currentEvent.time
					});
				}
				else{
					ref.push(me.currentEvent);
				}*/
				this.fire('add-training', {training : me.currentEvent});
				app.displayMessageToast('Evènement enregistré');
				this.selectedPage = 0;
			},
			cancelEvent: function(){
				this.selectedPage = 0;
			}
		});
	})();
</script>
</dom-module>
