<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="training-calendar">
<template>
	<style include="shared-styles">
		:host {
			display: block;
		}

		span,
		input {
			@apply(--paper-font-body2);
		}
		@media (max-width: 600px) {

			.flex {
				@apply(--layout-horizontal);
				@apply(--layout-wrap);
			}
		}

		.flex {
				@apply(--layout-horizontal);
				@apply(--layout-wrap);
			}

		.flex paper-material{
			width: 14%;
			height: 100px;
			margin-right:4px;
			margin-bottom:4px;
			min-width: 100px;
		}

		.monthPicker {
			@apply(--layout-horizontal);
			@apply(--layout-wrap);

		}

		.month{
			font-size: 0.8rem;
		}

		.day {
			color: #EEE;
			text-align: center;
			vertical-align: middle;
			font-size: 5rem;
			position: relative;
		}

		.flex .empty{
			width: 14%;
			height: 100px;
			margin-right:4px;
			margin-bottom:4px;
		}

		.race{
			color: red;
		}

		.training{
			color: green;
		}

		.event{
			  position: absolute;
			  top: 0;
			  left: 0;
			width: 100%
		}
	</style>
	<div>

	<paper-dropdown-menu label="Mois">
	<paper-listbox class="dropdown-content monthPicker" attr-for-selected="value" selected="{{month}}">
		<template is="dom-repeat" items="[[monthes]]">
			<paper-item value="{{item.id}}" class="month">{{item.name}}</paper-item>
		</template>
	</paper-listbox>
	</paper-dropdown-menu>


	<paper-dropdown-menu flex  label="Année">
	<paper-listbox class="dropdown-content" attr-for-selected="value"  selected="{{year}}">
		<paper-item value="2016">2016</paper-item>
		<paper-item value="2017">2017</paper-item>
	</paper-listbox>
	</paper-dropdown-menu>
	</div>
	<div class="container flex">
		<template is="dom-repeat" items="[[days]]" as="day" >
			<template is="dom-if" if="{{!day}}">
				<div class="empty"><span>{{day.dayNumber}}</span></div>
			</template>
			<template is="dom-if" if="{{day}}">
				<paper-material elevation="1">
				<div class="day">
					{{day.dayNumber}}
				</div>
				<div class="event">
					<template is="dom-repeat" items="[[day.logs]]">
						<div class="{{item.type}}">{{item.type}}</div>
					</template>
				</div>
				</paper-material>
			</template>
		</template>
	</div>
</template>

<script>
	(function() {
		'use strict';

		Polymer({
			is: 'training-calendar',

			properties: {
				month: {
					type: String,
					notify: true
				},
				year: {
					type: String,
					notify: true
				},

				days: {
					type: Array,
					notify: true
				},

				monthes: {
					type: Array,
					value: [
						{id: "01", name: "Janvier"},
						{id: "02", name: "Février"},
						{id: "03", name: "Mars"},
						{id: "04", name: "Avril"},
						{id: "05", name: "Mai"},
						{id: "06", name: "Juin"},
						{id: "07", name: "Juillet"},
						{id: "08", name: "Août"},
						{id: "09", name: "Septembre"},
						{id: "10", name: "Octobre"},
						{id: "11", name: "Novembre"},
						{id: "12", name: "Décembre"}
					],
					notify: true
				}
			},

			observers: [ "computeCalendar(month, year)"],


			getDaysToMonday: function(d) {
				var dayOfWeek = new Date(d.getFullYear(), d.getMonth(), 1).getDay();
				if(dayOfWeek == 0){
					return 6;
				}
				else{
					return dayOfWeek - 1;
				}
			},
			getDayIndex: function(dayNumber, diff){
				var index = _.findIndex(this.days, function(d){
					if(d === null){ return false; }
					return d.dayNumber == dayNumber;
				});
				return index - (diff == 0 ? 0 : diff - 1);
			},
			computeCalendar: function(m,y){
				if(m !== undefined && y !== undefined){
					this.days = new Array();
					var date = new Date(y, m, 0);
					var limit = parseInt(date.getDate());
					var diff = this.getDaysToMonday(date);
					//add empty days
					for(var j = 0; j < diff; j++){
						this.push('days',null);
					}
					//Generate month calendar
					for(var i = 0; i < limit; i++){
						var o = {
							fullDate: new Date(this.year, this.month, i + 1),
							dayNumber: i + 1,
							logs: []
						};
						this.push('days',o);
					}

					//Get logs
					var me = this;
					var ref = new Firebase(app.firebaseURL + '/training-log/' + app.authData.uid +'/' + y + '/' + m);
    				ref.on('child_added', function(snapshot) {
    					var newLog = snapshot.val();
    					var dIndex = me.getDayIndex(newLog.dayNumber, diff);
    					if(dIndex > -1){
    						newLog.uid = snapshot.key();
    						me.push("days.#" + dIndex + ".logs", newLog);
    					}
    				});
    				ref.on('child_changed', function(snapshot, previous) {
    					var updatedLog = snapshot.val();
    					updatedLog.uid = snapshot.key();
    					var dIndex = me.getDayIndex(updatedLog.dayNumber, diff);
    					if(dIndex > -1){
    						var d = me.get('days.#' + dIndex);
    						var index = _.findIndex(d.logs, function(d){
								return d.uid == snapshot.key();
							});
							//day changed
							if(index > -1) {
								me.splice("days.#" + dIndex + ".logs", index, 1,updatedLog);
							}
							console.log(index);
    						/*me.splice("days", dIndex, 1);
    						me.splice("days.#" + dIndex + ".logs", updatedLog);*/
    					}
    				});
    				ref.on('child_removed', function(snapshot, previous) {
    					var deletedLog = snapshot.val();
    					var dIndex = me.getDayIndex(deletedLog.dayNumber, diff);
    					if(dIndex > -1){
    						var d = me.get('days.#' + dIndex);
    						var index = _.findIndex(d.logs, function(d){
								return d.uid == snapshot.key();
							});
							if(index > -1) me.splice("days.#" + dIndex + ".logs", index, 1);
    					}
    				});
				}
			}
		});
	})();
</script>
</dom-module>
